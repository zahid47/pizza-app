import Link from "next/link";
import styles from "../styles/NavBar.module.css";
import useUserStore from "../context/userStore";
import { useEffect, useState } from "react";
import Cookies from "js-cookie";
import axios from "../utils/axios";
import { useRouter } from "next/router";
import useCartStore from "../context/cartStore";

export default function NavBar() {
  const { user, setUser } = useUserStore();
  const cartContent = useCartStore((state) => state.cartContent);
  const [cartQty, setCartQty] = useState(0);
  const router = useRouter();

  useEffect(() => {
    setCartQty(
      cartContent.reduce((totalQty: number, product: any) => {
        return totalQty + product.quantity;
      }, 0)
    );
  }, [cartContent]);

  useEffect(() => {
    const accessToken = Cookies.get("accessToken");

    const getMe = async (accessToken: string) => {
      try {
        const response = await axios.get("/auth/me", {
          headers: { Authorization: `Bearer ${accessToken}` },
        });
        const user = {
          name: response.data.name,
          role: response.data.role,
        };

        setUser(user);
      } catch {
        Cookies.remove("accessToken");
      }
    };

    // skipcq
    if (accessToken) getMe(accessToken);
  }, [setUser]);

  const logOut = () => {
    Cookies.remove("accessToken");
    setUser({});
    router.push("/");
  };

  return (
    <div className={styles.container}>
      <ul className={styles.list}>
        <li className={styles.link}>
          <Link href={"/"}>
            <svg
              width="133"
              height="40"
              viewBox="0 0 133 40"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M11.2836 31.708C10.4036 31.444 9.43559 31.884 9.17159 32.808C8.90759 33.292 7.71959 34.524 7.01559 34.348C6.88359 34.348 3.89159 33.468 3.89159 17.716C3.89159 6.1 6.75159 4.516 7.32359 4.34C8.07159 4.076 8.95159 4.604 9.39159 5.22C9.96359 5.968 11.0636 6.1 11.8116 5.528C12.5596 4.956 12.6916 3.9 12.1196 3.152C10.9316 1.524 8.59959 0.291998 6.22359 1.084C2.39559 2.36 0.459594 7.992 0.459594 17.716C0.459594 30.74 2.39559 37.12 6.53159 37.736C6.75159 37.78 6.92759 37.78 7.14759 37.78C9.83159 37.78 12.0316 35.14 12.3836 33.908C12.6916 32.984 12.2076 31.972 11.2836 31.708ZM24.1189 35.272C24.0309 34.612 23.8109 31.796 23.4589 20.18C23.3709 17.452 23.3709 15.296 23.3269 13.536C23.3269 10.94 23.2829 9.048 23.1069 7.068C23.0189 6.144 22.1389 5.44 21.2149 5.528C20.2909 5.616 19.5869 6.452 19.6749 7.42C19.8509 9.224 19.8949 11.072 19.8949 13.58C19.9389 15.252 19.9389 17.232 20.0269 19.696L17.9149 19.916C17.8269 15.868 17.7389 11.468 17.6949 7.244C17.6949 6.276 16.9029 5.528 15.9789 5.528C15.0109 5.528 14.2629 6.32 14.2629 7.288C14.3069 11.072 14.3949 15.868 14.4829 20.444C13.9549 20.796 13.6469 21.412 13.6909 22.072C13.7789 22.644 14.1309 23.084 14.5709 23.348C14.7909 29.904 15.0989 35.58 15.5829 36.592C15.8909 37.252 16.5069 37.604 17.1669 37.604C17.4309 37.604 17.6509 37.56 17.8709 37.472C18.7509 37.076 19.1029 36.108 18.7069 35.228C18.4429 34.348 18.1789 29.552 18.0029 23.348L20.1149 23.128C20.5989 37.56 20.6869 37.56 22.5349 37.56C23.4589 37.56 24.2509 36.812 24.2509 35.888C24.2509 35.668 24.2069 35.448 24.1189 35.272ZM35.9934 31.972C35.1574 31.532 34.1454 31.884 33.7054 32.72C33.1334 33.82 32.6934 34.084 32.6934 34.128C31.8574 33.776 30.2294 29.728 30.9334 24.844C31.2854 22.336 32.2534 21.544 32.8254 21.412C32.9574 21.412 33.0894 21.412 33.2214 21.368C34.1014 21.324 34.8054 20.576 34.8054 19.696C34.8494 18.816 34.1454 18.068 33.2654 17.98C33.0894 17.936 32.9134 17.936 32.6934 17.98C32.2534 17.936 31.6814 17.716 31.1534 16.924C30.0094 15.252 29.8334 12.392 30.4494 11.072C30.7134 10.412 31.5934 9.576 31.9894 9.576C31.9894 9.576 32.3854 9.796 32.7814 10.544C33.2214 11.38 34.2774 11.688 35.1134 11.248C35.9494 10.808 36.2574 9.796 35.8174 8.96C34.5854 6.584 33.0014 6.1 31.9014 6.144C29.7014 6.188 27.9414 8.256 27.3254 9.62C26.1374 12.216 26.5774 16.352 28.3374 18.86C28.6014 19.3 28.9094 19.652 29.2614 19.96C28.4694 20.928 27.8534 22.336 27.5454 24.36C26.7534 29.64 28.2494 36.328 31.6814 37.428C31.9454 37.516 32.2974 37.56 32.6934 37.56C33.8374 37.56 35.3774 36.944 36.7414 34.26C37.1814 33.424 36.8294 32.412 35.9934 31.972ZM47.8528 31.972C47.0168 31.532 46.0048 31.884 45.5648 32.72C44.9928 33.82 44.5528 34.084 44.5528 34.128C43.7168 33.776 42.0888 29.728 42.7928 24.844C43.1448 22.336 44.1128 21.544 44.6848 21.412C44.8168 21.412 44.9488 21.412 45.0808 21.368C45.9608 21.324 46.6648 20.576 46.6648 19.696C46.7088 18.816 46.0048 18.068 45.1248 17.98C44.9488 17.936 44.7728 17.936 44.5528 17.98C44.1128 17.936 43.5408 17.716 43.0128 16.924C41.8688 15.252 41.6928 12.392 42.3088 11.072C42.5728 10.412 43.4528 9.576 43.8488 9.576C43.8488 9.576 44.2448 9.796 44.6408 10.544C45.0808 11.38 46.1368 11.688 46.9728 11.248C47.8088 10.808 48.1168 9.796 47.6768 8.96C46.4448 6.584 44.8608 6.1 43.7608 6.144C41.5608 6.188 39.8008 8.256 39.1848 9.62C37.9968 12.216 38.4368 16.352 40.1968 18.86C40.4608 19.3 40.7688 19.652 41.1208 19.96C40.3288 20.928 39.7128 22.336 39.4048 24.36C38.6128 29.64 40.1088 36.328 43.5408 37.428C43.8048 37.516 44.1568 37.56 44.5528 37.56C45.6968 37.56 47.2368 36.944 48.6008 34.26C49.0408 33.424 48.6888 32.412 47.8528 31.972ZM59.6241 29.068C59.4041 24.58 57.7761 22.82 56.3681 21.324C55.1361 20.004 54.0801 18.86 53.7721 15.428C53.5081 12.128 53.8601 10.544 54.1241 9.84C54.2121 10.016 54.2561 10.236 54.3001 10.544C54.3441 11.512 55.1361 12.216 56.1041 12.172C57.0281 12.128 57.7761 11.292 57.7321 10.368C57.6001 8.564 56.6761 6.98 55.3561 6.32C54.3881 5.88 53.3321 5.924 52.4521 6.54C50.6921 7.728 49.9881 10.808 50.3841 15.692C50.7361 20.312 52.4521 22.16 53.8601 23.656C55.0481 24.932 56.0161 25.988 56.1921 29.244C56.2801 31.4 55.8401 32.984 55.4001 33.864C55.2241 33.204 55.0041 32.104 54.9601 30.168C54.9601 29.244 54.1681 28.496 53.2441 28.496C53.2441 28.496 53.2441 28.496 53.2001 28.496C52.2761 28.496 51.5281 29.288 51.5281 30.256C51.6601 34.348 52.4521 36.768 54.0361 37.604C54.4321 37.824 54.8721 37.912 55.2681 37.912C55.7961 37.912 56.2801 37.78 56.7641 37.472C58.6121 36.328 59.7561 32.852 59.6241 29.068ZM72.4721 21.28C72.2961 8.696 71.7681 6.584 69.8761 5.924C69.4361 5.748 68.2921 5.572 67.1921 6.936C66.9281 7.288 66.2241 8.212 64.0681 22.82L61.8681 23.216C60.9441 23.392 60.3281 24.272 60.5041 25.196C60.6361 26.032 61.3841 26.604 62.1761 26.604C62.2641 26.604 62.3961 26.604 62.4841 26.604L63.5841 26.384C63.1881 29.068 62.7481 32.148 62.3081 35.624C62.1761 36.592 62.8361 37.428 63.7601 37.56C64.6841 37.692 65.5641 37.032 65.6961 36.108C66.1361 32.94 66.6201 29.288 67.1481 25.724L69.0841 25.372C69.1281 28.54 69.1281 32.06 69.1281 35.756V38.22C69.1281 39.188 69.9201 39.936 70.8441 39.936C71.8121 39.936 72.5601 39.188 72.5601 38.22V35.756C72.5601 31.488 72.5161 27.88 72.5161 24.756L73.0001 24.668C73.9241 24.492 74.5401 23.612 74.3641 22.688C74.1881 21.764 73.3521 21.192 72.4721 21.28ZM67.6761 22.16C68.0721 19.344 68.5121 16.66 68.8641 14.504C68.9521 16.528 69.0401 19.036 69.0401 21.896L67.6761 22.16ZM86.4184 32.984C85.8464 31.884 83.9544 25.944 82.5464 21.456C82.8544 21.324 83.2064 21.148 83.5144 20.884C85.0984 19.652 86.0224 17.408 86.1544 14.284C86.4184 9.708 85.4944 6.892 83.3824 5.704C80.8744 4.296 78.0584 6.1 77.7504 6.32C77.3104 6.584 77.0464 7.068 77.0024 7.596C76.6064 12.128 76.5184 18.948 77.3544 37.384C77.3984 38.308 78.1904 39.012 79.0704 39.012C79.1144 39.012 79.1144 39.012 79.1584 39.012C80.1264 38.968 80.8304 38.176 80.7864 37.208C80.5664 32.764 80.4344 29.024 80.3024 25.812C81.4464 29.332 82.8104 33.424 83.3824 34.568C83.8224 35.404 84.8784 35.756 85.7144 35.272C86.5504 34.832 86.8584 33.82 86.4184 32.984ZM81.4904 18.112C81.0944 18.464 80.6984 18.42 80.6984 18.42C80.6104 18.42 80.4784 18.376 80.3464 18.376C80.3024 18.376 80.2144 18.376 80.1264 18.42C80.0824 13.932 80.1704 11.072 80.3464 8.828C80.7864 8.652 81.3584 8.52 81.7104 8.696C81.9304 8.828 82.9864 9.664 82.7664 14.108C82.5904 16.792 81.8864 17.76 81.4904 18.112ZM97.9543 31.972C97.1183 31.532 96.1063 31.884 95.6663 32.72C95.0943 33.82 94.6543 34.084 94.6543 34.128C93.8183 33.776 92.1903 29.728 92.8943 24.844C93.2463 22.336 94.2143 21.544 94.7863 21.412C94.9183 21.412 95.0503 21.412 95.1823 21.368C96.0623 21.324 96.7663 20.576 96.7663 19.696C96.8103 18.816 96.1063 18.068 95.2263 17.98C95.0503 17.936 94.8743 17.936 94.6543 17.98C94.2143 17.936 93.6423 17.716 93.1143 16.924C91.9703 15.252 91.7943 12.392 92.4103 11.072C92.6743 10.412 93.5543 9.576 93.9503 9.576C93.9503 9.576 94.3463 9.796 94.7423 10.544C95.1823 11.38 96.2383 11.688 97.0743 11.248C97.9103 10.808 98.2183 9.796 97.7783 8.96C96.5463 6.584 94.9623 6.1 93.8623 6.144C91.6623 6.188 89.9023 8.256 89.2863 9.62C88.0983 12.216 88.5383 16.352 90.2983 18.86C90.5623 19.3 90.8703 19.652 91.2223 19.96C90.4303 20.928 89.8143 22.336 89.5063 24.36C88.7143 29.64 90.2103 36.328 93.6423 37.428C93.9063 37.516 94.2583 37.56 94.6543 37.56C95.7983 37.56 97.3383 36.944 98.7023 34.26C99.1423 33.424 98.7903 32.412 97.9543 31.972ZM108.494 34.744C108.23 33.82 107.306 33.292 106.382 33.556C105.898 33.688 105.414 33.82 104.974 33.952C104.886 31.4 104.754 26.824 104.622 20.488C104.49 13.712 104.402 7.376 104.402 7.376C104.358 6.408 103.61 5.66 102.686 5.66C102.642 5.66 102.642 5.66 102.642 5.66C101.718 5.704 100.926 6.452 100.97 7.42C100.97 7.42 101.058 13.8 101.19 20.576C101.41 29.112 101.542 34.304 101.674 35.976C101.718 36.504 102.026 36.988 102.422 37.296C102.686 37.472 102.906 37.648 103.522 37.648C104.182 37.648 105.282 37.428 107.35 36.856C108.23 36.592 108.758 35.624 108.494 34.744ZM117.818 34.744C117.554 33.82 116.63 33.292 115.706 33.556C115.222 33.688 114.738 33.82 114.298 33.952C114.21 31.4 114.078 26.824 113.946 20.488C113.814 13.712 113.726 7.376 113.726 7.376C113.682 6.408 112.934 5.66 112.01 5.66C111.966 5.66 111.966 5.66 111.966 5.66C111.042 5.704 110.25 6.452 110.294 7.42C110.294 7.42 110.382 13.8 110.514 20.576C110.734 29.112 110.866 34.304 110.998 35.976C111.042 36.504 111.35 36.988 111.746 37.296C112.01 37.472 112.23 37.648 112.846 37.648C113.506 37.648 114.606 37.428 116.674 36.856C117.554 36.592 118.082 35.624 117.818 34.744ZM130.222 21.28C130.046 8.696 129.518 6.584 127.626 5.924C127.186 5.748 126.042 5.572 124.942 6.936C124.678 7.288 123.974 8.212 121.818 22.82L119.618 23.216C118.694 23.392 118.078 24.272 118.254 25.196C118.386 26.032 119.134 26.604 119.926 26.604C120.014 26.604 120.146 26.604 120.234 26.604L121.334 26.384C120.938 29.068 120.498 32.148 120.058 35.624C119.926 36.592 120.586 37.428 121.51 37.56C122.434 37.692 123.314 37.032 123.446 36.108C123.886 32.94 124.37 29.288 124.898 25.724L126.834 25.372C126.878 28.54 126.878 32.06 126.878 35.756V38.22C126.878 39.188 127.67 39.936 128.594 39.936C129.562 39.936 130.31 39.188 130.31 38.22V35.756C130.31 31.488 130.266 27.88 130.266 24.756L130.75 24.668C131.674 24.492 132.29 23.612 132.114 22.688C131.938 21.764 131.102 21.192 130.222 21.28ZM125.426 22.16C125.822 19.344 126.262 16.66 126.614 14.504C126.702 16.528 126.79 19.036 126.79 21.896L125.426 22.16Z"
                fill="white"
              />
            </svg>
          </Link>
        </li>
        <li className={styles.link}>
          <Link href={"/cart"} passHref>
            <a>Cart ({cartQty})</a>
          </Link>
        </li>
        <li className={styles.link}>
          {user.name ? (
            <>
              <Link href={"/orders"} passHref>
                <a>My Orders</a>
              </Link>
              <button onClick={logOut}>Log Out</button>
            </>
          ) : (
            <Link href={"/login"} passHref>
              <a>Login</a>
            </Link>
          )}
        </li>
      </ul>
    </div>
  );
}
